import{AutoTokenizer as e,env as t,pipeline as n}from"@sroussey/transformers";import{MemoryVectorStore as r}from"@langchain/classic/vectorstores/memory";import{Embeddings as i}from"@langchain/core/embeddings";import a from"lodash";import o from"jsan";var s=class extends i{env=t;DEBUG=!0;generator=null;generatorModelName=`Xenova/LaMini-GPT-774M`;generatorPromise=null;generatorProgressInfo={};generatorProgressCallback=null;generatorAbortController=new AbortController;summariser=null;summariserModelName=`Xenova/distilbart-cnn-12-6`;summariserPromise=null;summariserProgressInfo={};summariserProgressCallback=null;summariserAbortController=new AbortController;embedder=null;embedderModelName=`Xenova/all-MiniLM-L12-v2`;embedderPromise=null;embedderProgressInfo={};embedderProgressCallback=null;embedderAbortController=new AbortController;tokeniser=null;tokeniserModelName=this.generatorModelName;tokeniserPromise=null;tokeniserProgressInfo={};tokeniserProgressCallback=null;tokeniserAbortController=new AbortController;generateSearchAreasMaxNewTokens=64;generateSearchAreasTemperature=.35;generateSearchAreasRepetitionPenalty=1.5;rankingMaxNewTokens=64;rankingTemperature=.35;rankingRepetitionPenalty=1.5;targetSummarisedStringTokenCount=420;static{t.localModelPath=``,t.allowRemoteModels=!0,t.allowLocalModels=!1}constructor(){super({})}async loadGenerator({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.generatorModelName=t),!this.generatorModelName)throw Error(`Invalid generator model name`);return e&&(this.generatorProgressCallback=e),this.generatorPromise=n(`text-generation`,this.generatorModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(o.stringify(e)),Object.assign(this.generatorProgressInfo,e),this.generatorProgressCallback?.(e)),abort_signal:this.generatorAbortController.signal}),this.generator=await this.generatorPromise,this.generator}async checkGeneratorLoaded({progressCallback:e,modelName:t=``}={}){if(this.generatorPromise||this.loadGenerator({progressCallback:e,modelName:t}),!this.generator)try{await this.generatorPromise}catch(e){throw this.generatorPromise=null,e}if(!this.generator)throw this.generatorPromise=null,Error(`Unable to load generator`)}async abortLoadGenerator(e){this.generatorAbortController.abort(e),this.generatorAbortController=new AbortController}async loadSummariser({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.summariserModelName=t),!this.summariserModelName)throw Error(`Invalid summariser model name`);return e&&(this.summariserProgressCallback=e),this.summariserPromise=n(`summarization`,this.summariserModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(o.stringify(e)),Object.assign(this.summariserProgressInfo,e),this.summariserProgressCallback?.(e)),abort_signal:this.summariserAbortController.signal}),this.summariser=await this.summariserPromise,this.summariser}async checkSummariserLoaded({progressCallback:e,modelName:t=``}={}){if(this.summariserPromise||this.loadSummariser({progressCallback:e,modelName:t}),!this.summariser)try{await this.summariserPromise}catch(e){throw this.summariserPromise=null,e}if(!this.summariser)throw this.summariserPromise=null,Error(`Unable to load summariser`)}async abortLoadSummariser(){this.summariserAbortController.abort(),this.summariserAbortController=new AbortController}async loadEmbedder({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.embedderModelName=t),!this.embedderModelName)throw Error(`Invalid embedder model name`);return e&&(this.embedderProgressCallback=e),this.embedderPromise=n(`feature-extraction`,this.embedderModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(o.stringify(e)),Object.assign(this.embedderProgressInfo,e),this.embedderProgressCallback?.(e)),abort_signal:this.embedderAbortController.signal}),this.embedder=await this.embedderPromise,this.embedder}async checkEmbedderLoaded({progressCallback:e,modelName:t=``}={}){if(this.embedderPromise||this.loadEmbedder({progressCallback:e,modelName:t}),!this.embedder)try{await this.embedderPromise}catch(e){throw this.embedderPromise=null,e}if(!this.embedder)throw this.embedderPromise=null,Error(`Unable to load embedder`)}async abortLoadEmbedder(){this.embedderAbortController.abort(),this.embedderAbortController=new AbortController}async loadTokeniser({progressCallback:t,modelName:n=``}={}){if(typeof n==`string`&&n&&(this.tokeniserModelName=n),!this.tokeniserModelName)throw Error(`Invalid tokeniser model name`);return t&&(this.tokeniserProgressCallback=t),this.tokeniserPromise=e.from_pretrained(this.tokeniserModelName,{progress_callback:e=>(this.DEBUG&&console.log(o.stringify(e)),Object.assign(this.tokeniserProgressInfo,e),this.tokeniserProgressCallback?.(e)),abort_signal:this.tokeniserAbortController.signal}),this.tokeniser=await this.tokeniserPromise,this.tokeniser}async checkTokeniserLoaded({progressCallback:e,modelName:t=``}={}){if(this.tokeniserPromise||this.loadTokeniser({progressCallback:e,modelName:t}),!this.tokeniser)try{await this.tokeniserPromise}catch(e){throw this.tokeniserPromise=null,e}if(!this.tokeniser)throw this.tokeniserPromise=null,Error(`Unable to load tokeniser`)}async abortLoadTokeniser(){this.tokeniserAbortController.abort(),this.tokeniserAbortController=new AbortController}async embedQuery(e){return await this.checkEmbedderLoaded(),Array.from((await this.embedder?.(e,{pooling:`mean`,normalize:!0}))?.data)}async embedDocuments(e){return Promise.all(e.map(e=>this.embedQuery(e)))}defaultGeneratePromptTemplate(e){return`Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
`+e+`

### Response:`}defaultGenerateSearchAreasInstruction(e){return`List the relevant subject areas for the following issues. Limit your response to 100 words.
Issues: "`+e+`"`}defaultConvertCandidateToDocument({candidate:e,index:t}={}){let n=`Start of Candidate #`+t;for(let t in e)n+=`
`+a.startCase(t)+`: `+(typeof e[t]==`object`?o.stringify(e[t]):String(e[t]));return n+=`
End of Candidate #`+t,n}defaultGenerateRankingInstruction({problemDescription:e,summaries:t,candidatesForFinalSelection:n,candidateIdentifierField:r}={}){return`Strictly follow these rules:
1. Rank ONLY the top `+n+` candidates with one 15-word sentence explaining why
2. Rank the candidates based on "`+e.replace(/(\r|\n)/g,` `)+`"
3. If unclear, say "Insufficient information to determine"

Candidates:

`+t.join(`

`)+`

Format exactly:
#1. "Full `+a.startCase(r)+`": 15-word explanation
#2. ...`}regexIndexOf(e,t,n){let r=e.slice(n).search(t);return r<0?r:r+n}defaultExtractIdentifierFromCandidateDocument({candidateDocument:e,candidateIdentifierField:t}={}){this.DEBUG&&console.log(e,t);let n=a.startCase(t),r=e.indexOf(n);if(r<0&&(r=e.toLowerCase().indexOf(n.toLowerCase())),this.DEBUG&&console.log(r),r>=0&&(r+=n.length),r<0&&(r=e.toLowerCase().indexOf(t.toLowerCase()),r>=0&&(r+=t.length)),this.DEBUG)console.log(r);else return``;if(r=e.indexOf(`:`,r),this.DEBUG&&console.log(r),r<0&&(r=this.regexIndexOf(e,/\s+/,r)),this.DEBUG&&console.log(r),r<0)return``;let i=e.indexOf(`
`,r);return i<0&&(i=e.length),this.DEBUG&&console.log(i),e.substring(r,i).trim()}defaultExtractIdentifiersFromRationale(e){let t=/^\s*#\s*\d+\s*\.?\s*"([^"]+)"/gm,n=[];for(let r;Array.isArray(r=t.exec(e));)r[1]&&n.push(r[1]);return n}defaultParseSearchAreasResponse(e){let t=String(e).indexOf(`### Response:`);return t>=0?t+=13:t=0,String(e).substring(t).trim()}async compareCandidates({candidates:e,problemDescription:t=``,generateSearchAreasInstruction:n=this.defaultGenerateSearchAreasInstruction.bind(this),parseSearchAreasResponse:i=this.defaultParseSearchAreasResponse.bind(this),convertCandidateToDocument:o=this.defaultConvertCandidateToDocument.bind(this),candidatesForInitialSelection:s=2,candidatesForFinalSelection:c=1,generateRankingInstruction:l=this.defaultGenerateRankingInstruction.bind(this),extractIdentifiersFromRationale:u=this.defaultExtractIdentifiersFromRationale.bind(this),extractIdentifierFromCandidateDocument:d=this.defaultExtractIdentifierFromCandidateDocument.bind(this),candidateIdentifierField:f=void 0,getSummarisableSubstringIndices:p,generatePromptTemplate:m=this.defaultGeneratePromptTemplate.bind(this),skipRationale:h=!1}={}){if(!Array.isArray(e)||e.length<=0)throw Error(`No candidates provided`);if(s=a.toSafeInteger(s),s<=0||(c=a.toSafeInteger(c),c<=0))throw Error(`Candidates for initial selection must be a positive integer bigger than 0`);if(s<c)throw Error(`Candidates for initial selection must be equal or more than candidates for final selection`);if(s>e.length)throw Error(`There are `+s+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(c>e.length)throw Error(`There are `+c+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(!f&&(f=Object.keys(e[0])[0],!f))throw Error(`No candidate identifier field`);let g=``,_=[];if(await this.checkEmbedderLoaded(),!this.embedder)return;let v=e.map((e,t)=>o({candidate:e,index:t})),y=await r.fromTexts(a.cloneDeep(v),v.map((e,t)=>t),this),b=m(n(t));if(this.DEBUG&&console.log(`Formatted search areas prompt: `+b),await this.checkTokeniserLoaded(),!this.tokeniser)return;if(this.tokeniser.encode(b).length>this.tokeniser.model_max_length)throw Error(`Search areas instruction prompt is too long for the tokeniser model`);if(await this.checkGeneratorLoaded(),!this.generator)return;let x=this.tokeniser.pad_token_id??this.tokeniser.sep_token_id??0,S=this.tokeniser.sep_token_id??2,C=await this.generator(b,{max_new_tokens:this.generateSearchAreasMaxNewTokens,temperature:this.generateSearchAreasTemperature,repetition_penalty:this.generateSearchAreasRepetitionPenalty,pad_token_id:x,eos_token_id:S}),w=Array.isArray(C?.[0])?C?.[0]?.[0]:C?.[0];if(!w.generated_text)throw Error(`No generated text for search areas`);this.DEBUG&&console.log(`Generated search areas response: `+w.generated_text);let T=i(Array.isArray(w.generated_text)?w.generated_text.join(`

`):String(w.generated_text));this.DEBUG&&console.log(`Vector search query: `+T);let E=await y.similaritySearch(T,s);this.DEBUG&&console.log(`Vector search results: `,E);let D=[];if(E.some(e=>e.pageContent.trim().split(/\s+/).length>this.targetSummarisedStringTokenCount)){if(await this.checkSummariserLoaded(),!this.summariser)return;D=(await Promise.allSettled(E.map(async e=>{if(!e.pageContent||typeof e.pageContent!=`string`)return``;if(e.pageContent.trim().split(/\s+/).length<=this.targetSummarisedStringTokenCount)return e.pageContent;let t={start:0,end:e.pageContent.length};p&&Object.assign(t,p(e.pageContent)),t.start=a.clamp(a.toSafeInteger(t.start),0,e.pageContent.length),t.end=a.clamp(a.toSafeInteger(t.end),0,e.pageContent.length);let n=e.pageContent.substring(t.start,t.end),r=e.pageContent.substring(0,t.start),i=e.pageContent.substring(t.end),o=r.split(/s+/).length+i.split(/s+/).length,s=Math.max(1,this.targetSummarisedStringTokenCount-o),c=await this.summariser?.(n,{max_length:s}),l=r+((Array.isArray(c?.[0])?c?.[0]?.[0]:c?.[0])?.summary_text??``).split(/s+/).slice(s).join(` `)+i;return this.DEBUG&&console.log(`Summarised candidate: `+l),l}))).filter(e=>e.status===`fulfilled`&&e.value).map(e=>e.value)}else D=E.map(e=>e.pageContent);if(!h){let e=m(l({problemDescription:t,summaries:D,candidatesForFinalSelection:c,candidateIdentifierField:String(f)}));if(this.DEBUG&&console.log(`Formatted ranking prompt: `+e),this.tokeniser.encode(e).length>this.tokeniser.model_max_length)throw Error(`Ranking instruction prompt is too long for the tokeniser model`);try{let t=await this.generator(e,{max_new_tokens:this.rankingMaxNewTokens,temperature:this.rankingTemperature,repetition_penalty:this.rankingRepetitionPenalty,pad_token_id:x,eos_token_id:S});g=(Array.isArray(t?.[0])?t?.[0]?.[0]:t[0]).generated_text.toString().trim().replace(/(\*\*)|(<\/?s>)|(\[.*?\])\s*/g,``),this.DEBUG&&console.log(`Generated rationale: `+g);let n=g.indexOf(`### Response:`);n>=0?n+=13:n=0,g=g.substring(n)}catch(e){console.log(e),g=``}}if(g){let t=u(g);t.length>c&&(t=t.slice(0,c)),_=a.compact(t.map(t=>{let n=e.find(e=>String(e[f]).toLowerCase()===t.toLowerCase());return n||(n=e.find(e=>String(e[f]).toLowerCase().includes(t.toLowerCase())),n)||(n=e.find(e=>t.toLowerCase().includes(String(e[f]).toLowerCase())),n)?n:null}))}return(!Array.isArray(_)||_.length<=0)&&(_=a.uniq(a.compact(E.map(t=>{let n=d({candidateDocument:t.pageContent,candidateIdentifierField:String(f)});this.DEBUG&&console.log(`Extracted identifier from candidate document: `+n);let r=e.find(e=>String(e[f]).toLowerCase()===n.toLowerCase());return r||(r=e.find(e=>String(e[f]).toLowerCase().includes(n.toLowerCase())),r)||(r=e.find(e=>n.toLowerCase().includes(String(e[f]).toLowerCase())),r)?r:null}))).slice(0,c)),this.DEBUG&&console.log(`Selected candidates`,_),{rationale:g,selectedCandidates:_}}};(function(e){})(s||={});var c=s;export{s as AICompareCandidates,c as default};
//# sourceMappingURL=index.mjs.map