Object.defineProperty(exports,`__esModule`,{value:!0});var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`@sroussey/transformers`),l=require(`@langchain/classic/vectorstores/memory`),u=require(`@langchain/core/embeddings`),d=require(`lodash`);d=s(d);let f=require(`jsan`);f=s(f);var p=class extends u.Embeddings{env=c.env;DEBUG=!0;generator=null;generatorModelName=`Xenova/Phi-3-mini-4k-instruct`;generatorPromise=null;generatorProgressInfo={};generatorProgressCallback=null;generatorAbortController=new AbortController;summariser=null;summariserModelName=`Xenova/distilbart-cnn-12-6`;summariserPromise=null;summariserProgressInfo={};summariserProgressCallback=null;summariserAbortController=new AbortController;embedder=null;embedderModelName=`Xenova/all-MiniLM-L12-v2`;embedderPromise=null;embedderProgressInfo={};embedderProgressCallback=null;embedderAbortController=new AbortController;tokeniser=null;tokeniserModelName=this.generatorModelName;tokeniserPromise=null;tokeniserProgressInfo={};tokeniserProgressCallback=null;tokeniserAbortController=new AbortController;generateSearchAreasMaxNewTokens=64;generateSearchAreasTemperature=.35;generateSearchAreasRepetitionPenalty=1.5;rankingMaxNewTokens=64;rankingTemperature=.35;rankingRepetitionPenalty=1.5;targetSummarisedStringTokenCount=300;static{c.env.localModelPath=``,c.env.allowRemoteModels=!0,c.env.allowLocalModels=!1}constructor(){super({})}async loadGenerator({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.generatorModelName=t),!this.generatorModelName)throw Error(`Invalid generator model name`);return e&&(this.generatorProgressCallback=e),this.generatorPromise=(0,c.pipeline)(`text-generation`,this.generatorModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.generatorProgressInfo,e),this.generatorProgressCallback?.(e)),abort_signal:this.generatorAbortController.signal}),this.generator=await this.generatorPromise,this.generator}async checkGeneratorLoaded({progressCallback:e,modelName:t=``}={}){if(this.generatorPromise||this.loadGenerator({progressCallback:e,modelName:t}),!this.generator)try{await this.generatorPromise}catch(e){throw this.generatorPromise=null,e}if(!this.generator)throw this.generatorPromise=null,Error(`Unable to load generator`)}async abortLoadGenerator(e){this.generatorAbortController.abort(e),this.generatorAbortController=new AbortController}async loadSummariser({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.summariserModelName=t),!this.summariserModelName)throw Error(`Invalid summariser model name`);return e&&(this.summariserProgressCallback=e),this.summariserPromise=(0,c.pipeline)(`summarization`,this.summariserModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.summariserProgressInfo,e),this.summariserProgressCallback?.(e)),abort_signal:this.summariserAbortController.signal}),this.summariser=await this.summariserPromise,this.summariser}async checkSummariserLoaded({progressCallback:e,modelName:t=``}={}){if(this.summariserPromise||this.loadSummariser({progressCallback:e,modelName:t}),!this.summariser)try{await this.summariserPromise}catch(e){throw this.summariserPromise=null,e}if(!this.summariser)throw this.summariserPromise=null,Error(`Unable to load summariser`)}async abortLoadSummariser(){this.summariserAbortController.abort(),this.summariserAbortController=new AbortController}async loadEmbedder({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.embedderModelName=t),!this.embedderModelName)throw Error(`Invalid embedder model name`);return e&&(this.embedderProgressCallback=e),this.embedderPromise=(0,c.pipeline)(`feature-extraction`,this.embedderModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.embedderProgressInfo,e),this.embedderProgressCallback?.(e)),abort_signal:this.embedderAbortController.signal}),this.embedder=await this.embedderPromise,this.embedder}async checkEmbedderLoaded({progressCallback:e,modelName:t=``}={}){if(this.embedderPromise||this.loadEmbedder({progressCallback:e,modelName:t}),!this.embedder)try{await this.embedderPromise}catch(e){throw this.embedderPromise=null,e}if(!this.embedder)throw this.embedderPromise=null,Error(`Unable to load embedder`)}async abortLoadEmbedder(){this.embedderAbortController.abort(),this.embedderAbortController=new AbortController}async loadTokeniser({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.tokeniserModelName=t),!this.tokeniserModelName)throw Error(`Invalid tokeniser model name`);return e&&(this.tokeniserProgressCallback=e),this.tokeniserPromise=c.AutoTokenizer.from_pretrained(this.tokeniserModelName,{progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.tokeniserProgressInfo,e),this.tokeniserProgressCallback?.(e)),abort_signal:this.tokeniserAbortController.signal}),this.tokeniser=await this.tokeniserPromise,this.tokeniser}async checkTokeniserLoaded({progressCallback:e,modelName:t=``}={}){if(this.tokeniserPromise||this.loadTokeniser({progressCallback:e,modelName:t}),!this.tokeniser)try{await this.tokeniserPromise}catch(e){throw this.tokeniserPromise=null,e}if(!this.tokeniser)throw this.tokeniserPromise=null,Error(`Unable to load tokeniser`)}async abortLoadTokeniser(){this.tokeniserAbortController.abort(),this.tokeniserAbortController=new AbortController}async embedQuery(e){return await this.checkEmbedderLoaded(),typeof this.embedder==`function`?Array.from((await this.embedder(e,{pooling:`mean`,normalize:!0}))?.data):[]}async embedDocuments(e){return Promise.all(e.map(e=>this.embedQuery(e)))}defaultGeneratePromptTemplate(e){return e}async defaultPerformGeneration({generator:e,tokeniser:t,prompt:n=``,textGenerationConfig:r={}}={}){let i=``;if(e||(i+=`No generator provided.`),t||(i+=(i?`
`:``)+`No tokeniser provided.`),(typeof n!=`string`||!n)&&(i+=(i?`
`:``)+`No valid prompt provided.`),i)throw Error(i);let a=[{role:`user`,content:n}];new c.TextStreamer(t,{skip_prompt:!0}),r.pad_token_id||=t.pad_token_id??t.sep_token_id??0,r.eos_token_id||=t.sep_token_id??2;let o=await e(a,r);this.DEBUG&&console.log(o);let s=Array.isArray(o?.[0])?o?.[0]?.[0]:o?.[0];if(!s.generated_text)throw Error(`No generated text`);if(typeof s.generated_text==`string`)return s.generated_text;let l=s.generated_text?.at(-1)?.content;if(typeof l!=`string`||!l)throw Error(`No content in generated text`);return l}defaultGenerateSearchAreasInstruction(e){return`List the relevant subject areas for the following issues. Limit your response to 100 words.
Issues: "`+e+`"`}defaultConvertCandidateToDocument({candidate:e,index:t}={}){let n=`Start of Candidate #`+t;for(let t in e)n+=`
`+d.default.startCase(t)+`: `+(typeof e[t]==`object`?f.default.stringify(e[t]):String(e[t]));return n+=`
End of Candidate #`+t,n}defaultGenerateRankingInstruction({problemDescription:e,summaries:t,candidatesForFinalSelection:n,candidateIdentifierField:r}={}){return`Rank only the top `+n+` candidates by connecting them to "`+e+`" stating # followed by the candidate number and the full `+d.default.startCase(r)+` followed by a 15-word explanation for each ranking. Stop generating text immediately thereafter.

Candidates:

`+t.join(`

`)}regexIndexOf(e,t,n){let r=e.slice(n).search(t);return r<0?r:r+n}defaultExtractIdentifierFromCandidateDocument({candidateDocument:e,candidateIdentifierField:t}={}){this.DEBUG&&console.log(e,t);let n=d.default.startCase(t),r=e.indexOf(n);if(r<0&&(r=e.toLowerCase().indexOf(n.toLowerCase())),this.DEBUG&&console.log(r),r>=0&&(r+=n.length),r<0&&(r=e.toLowerCase().indexOf(t.toLowerCase()),r>=0&&(r+=t.length)),this.DEBUG)console.log(r);else return``;if(r=e.indexOf(`:`,r),this.DEBUG&&console.log(r),r<0&&(r=this.regexIndexOf(e,/\s+/,r)),this.DEBUG&&console.log(r),r<0)return``;let i=e.indexOf(`
`,r);return i<0&&(i=e.length),this.DEBUG&&console.log(i),e.substring(r,i).trim()}defaultExtractIdentifiersFromRationale(e){let t=/^\d+?\s*?\p{P}\s*?(.+?)\s*?(-|\.|;|\n)/gmu,n=[];for(let r;Array.isArray(r=t.exec(e));)r[1]&&n.push(r[1]);return n}defaultFindCandidateFromIdentifier({identifier:e,candidateIdentifierField:t,candidates:n}={}){(!e||typeof e!=`string`)&&(e=String(e)),console.log(`identifier`,e);let r=n.find(n=>String(n[t])===e);if(r||(r=n.find(n=>String(n[t]).toLowerCase()===e.toLowerCase()),r)||(r=n.find(n=>String(n[t]).toLowerCase().includes(e.toLowerCase())),r)||(r=n.find(n=>e.toLowerCase().includes(String(n[t]).toLowerCase())),r))return this.DEBUG&&console.log(`Candidate found based on case-sensitive match`,r[t]),r;let i=e.split(/\s+/g).filter(e=>/\w/.test(e));this.DEBUG&&console.log(`Identifier words`,i);let a=n.map(e=>({identifierWordIndices:i.map(n=>String(e[t]).indexOf(n)),candidate:e})).filter(e=>e.identifierWordIndices.some(e=>e>=0));return a.length>1&&a.sort((e,t)=>{let n=d.default.sumBy(e.identifierWordIndices,e=>e<0?0:1),r=d.default.sumBy(t.identifierWordIndices,e=>e<0?0:1);if(this.DEBUG&&(console.log(`a`,e),console.log(`b`,t),console.log(`a.identifierWordIndices`,e.identifierWordIndices),console.log(`b.identifierWordIndices`,t.identifierWordIndices),console.log(`aCount`,n),console.log(`bCount`,r)),n!==r)return r-n;if(n===0&&r===0)return 0;n=0,r=0;for(let t=0;t<e.identifierWordIndices.length-1;++t)for(let r=t+1;r<e.identifierWordIndices.length;++r)e.identifierWordIndices[t]<0||e.identifierWordIndices[r]<0||e.identifierWordIndices[t]<e.identifierWordIndices[r]&&(this.DEBUG&&(console.log(`i`,t),console.log(`j`,r),console.log(`a.identifierWordIndices[i]`,e.identifierWordIndices[t]),console.log(`a.identifierWordIndices[j]`,e.identifierWordIndices[r])),++n);for(let e=0;e<t.identifierWordIndices.length-1;++e)for(let n=e+1;n<t.identifierWordIndices.length;++n)t.identifierWordIndices[e]<0||t.identifierWordIndices[n]<0||t.identifierWordIndices[e]<t.identifierWordIndices[n]&&(this.DEBUG&&(console.log(`i`,e),console.log(`j`,n),console.log(`b.identifierWordIndices[i]`,t.identifierWordIndices[e]),console.log(`b.identifierWordIndices[j]`,t.identifierWordIndices[n])),++r);return this.DEBUG&&(console.log(`aCount`,n),console.log(`bCount`,r)),r-n}),a.length>=1&&a[0].candidate?a[0].candidate:null}defaultParseSearchAreasResponse(e){let t=String(e).indexOf(`### Response:`);return t>=0?t+=13:t=0,String(e).substring(t).trim()}errorMessage(e){return typeof e?.response?.data==`string`?e.response.data:e?.response?.data?f.default.stringify(e.response.data):typeof e?.message==`string`?e.message:e?.message?f.default.stringify(e.message):typeof e==`string`?e:f.default.stringify(e)}async compareCandidates({candidates:e,problemDescription:t=``,performGeneration:n=this.defaultPerformGeneration.bind(this),generateSearchAreasInstruction:r=this.defaultGenerateSearchAreasInstruction.bind(this),parseSearchAreasResponse:i=this.defaultParseSearchAreasResponse.bind(this),convertCandidateToDocument:a=this.defaultConvertCandidateToDocument.bind(this),candidatesForInitialSelection:o=2,candidatesForFinalSelection:s=1,generateRankingInstruction:c=this.defaultGenerateRankingInstruction.bind(this),extractIdentifiersFromRationale:u=this.defaultExtractIdentifiersFromRationale.bind(this),extractIdentifierFromCandidateDocument:f=this.defaultExtractIdentifierFromCandidateDocument.bind(this),candidateIdentifierField:p=void 0,findCandidateFromIdentifier:m=this.defaultFindCandidateFromIdentifier.bind(this),getSummarisableSubstringIndices:h,generatePromptTemplate:g=this.defaultGeneratePromptTemplate.bind(this),skipRationale:_=!1,parallelSummarisation:v=!0}={}){if(!Array.isArray(e)||e.length<=0)throw Error(`No candidates provided`);if(o=d.default.toSafeInteger(o),o<=0||(s=d.default.toSafeInteger(s),s<=0))throw Error(`Candidates for initial selection must be a positive integer bigger than 0`);if(o<s)throw Error(`Candidates for initial selection must be equal or more than candidates for final selection`);if(o>e.length)throw Error(`There are `+o+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(s>e.length)throw Error(`There are `+s+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(!p&&(p=Object.keys(e[0])[0],!p))throw Error(`No candidate identifier field`);let y=``,b=[];if(await this.checkEmbedderLoaded(),!this.embedder)return;let x=e.map((e,t)=>a({candidate:e,index:t})),S=await l.MemoryVectorStore.fromTexts(d.default.cloneDeep(x),x.map((e,t)=>t),this),C=g(r(t));if(this.DEBUG&&console.log(`Formatted search areas prompt: `+C),await this.checkTokeniserLoaded(),!this.tokeniser)return;if(this.tokeniser.encode(C).length>this.tokeniser.model_max_length)throw Error(`Search areas instruction prompt is too long for the tokeniser model`);if(await this.checkGeneratorLoaded(),!this.generator)return;let w=await n({generator:this.generator,tokeniser:this.tokeniser,prompt:C,textGenerationConfig:{max_new_tokens:this.generateSearchAreasMaxNewTokens,temperature:this.generateSearchAreasTemperature,repetition_penalty:this.generateSearchAreasRepetitionPenalty}});this.DEBUG&&console.log(`Generated search areas response: `+w);let T=i(w);this.DEBUG&&console.log(`Vector search query: `+T);let E=await S.similaritySearch(T,o);this.DEBUG&&console.log(`Vector search results: `,E);let D=[];if(E.some(e=>e.pageContent.trim().split(/\s+/).length>this.targetSummarisedStringTokenCount)){if(await this.checkSummariserLoaded(),!this.summariser)return;if(v)D=(await Promise.allSettled(E.map(async e=>{if(!e.pageContent||typeof e.pageContent!=`string`)return``;if(e.pageContent.trim().split(/\s+/).length<=this.targetSummarisedStringTokenCount)return e.pageContent;let t={start:0,end:e.pageContent.length};h&&Object.assign(t,h(e.pageContent)),t.start=d.default.clamp(d.default.toSafeInteger(t.start),0,e.pageContent.length),t.end=d.default.clamp(d.default.toSafeInteger(t.end),0,e.pageContent.length),this.DEBUG&&console.log(t);let n=e.pageContent.substring(t.start,t.end);this.DEBUG&&console.log(n);let r=e.pageContent.substring(0,t.start),i=e.pageContent.substring(t.end),a=r.split(/\s+/).length+i.split(/\s+/).length,o=Math.max(1,this.targetSummarisedStringTokenCount-a);this.DEBUG&&console.log(a,o);let s=await this.summariser?.(n,{max_length:o}),c=Array.isArray(s?.[0])?s?.[0]?.[0]:s?.[0];this.DEBUG&&console.log(s,c,c?.summary_text??``,(c?.summary_text??``).split(/\s+/).slice(0,o).join(` `));let l=r+(c?.summary_text??``).split(/\s+/).slice(0,o).join(` `).trim()+i;return this.DEBUG&&console.log(`Summarised candidate: `+l),l}))).filter(e=>e.status===`fulfilled`&&e.value).map(e=>e.value);else for(let e of E)try{if(!e.pageContent||typeof e.pageContent!=`string`)continue;if(e.pageContent.trim().split(/\s+/).length<=this.targetSummarisedStringTokenCount){D.push(e.pageContent);continue}let t={start:0,end:e.pageContent.length};h&&Object.assign(t,h(e.pageContent)),t.start=d.default.clamp(d.default.toSafeInteger(t.start),0,e.pageContent.length),t.end=d.default.clamp(d.default.toSafeInteger(t.end),0,e.pageContent.length),this.DEBUG&&console.log(t);let n=e.pageContent.substring(t.start,t.end);this.DEBUG&&console.log(n);let r=e.pageContent.substring(0,t.start),i=e.pageContent.substring(t.end),a=r.split(/\s+/).length+i.split(/\s+/).length,o=Math.max(1,this.targetSummarisedStringTokenCount-a);this.DEBUG&&console.log(a,o);let s=await this.summariser?.(n,{max_length:o}),c=Array.isArray(s?.[0])?s?.[0]?.[0]:s?.[0];this.DEBUG&&console.log(s,c,c?.summary_text??``,(c?.summary_text??``).split(/\s+/).slice(0,o).join(` `));let l=r+(c?.summary_text??``).split(/\s+/).slice(0,o).join(` `).trim()+i;this.DEBUG&&console.log(`Summarised candidate: `+l),D.push(l)}catch(e){console.log(e),this.DEBUG&&console.log(this.summariser,typeof this.summariser)}}else D=E.map(e=>e.pageContent);let O=``;if(!_){let e=g(c({problemDescription:t,summaries:D,candidatesForFinalSelection:s,candidateIdentifierField:String(p)}));this.DEBUG&&console.log(`Formatted ranking prompt: `+e);let r=this.tokeniser.encode(e);if(this.DEBUG&&console.log(r.length,this.tokeniser.model_max_length),r.length>this.tokeniser.model_max_length)throw Error(`Ranking instruction prompt is too long for the tokeniser model`);try{y=(await n({generator:this.generator,tokeniser:this.tokeniser,prompt:e,textGenerationConfig:{max_new_tokens:this.rankingMaxNewTokens,temperature:this.rankingTemperature,repetition_penalty:this.rankingRepetitionPenalty}})).trim().replace(/(\*\*)|(<\/?s>)|(\[.*?\])\s*/g,``),this.DEBUG&&console.log(`Generated rationale: `+y);let t=y.indexOf(`### Response:`);t>=0?t+=13:t=0,y=y.substring(t)}catch(e){console.log(e),O=this.errorMessage(e),y=``}}if(y){let t=u(y);this.DEBUG&&console.log(`Extracted identifiers from rationale: `+t),t.length>s&&(t=t.slice(0,s)),b=d.default.compact(t.map(t=>m({identifier:t,candidateIdentifierField:p,candidates:e})))}if(!Array.isArray(b)||b.length<s){Array.isArray(b)||(b=[]);let t=d.default.compact(E.map(t=>{let n=f({candidateDocument:t.pageContent,candidateIdentifierField:String(p)});return this.DEBUG&&console.log(`Extracted identifier from candidate document: `+n),m({identifier:n,candidateIdentifierField:p,candidates:e})}));b.splice(b.length,0,...t),b=d.default.uniq(b).slice(0,s)}return this.DEBUG&&console.log(`Selected candidates`,b),{rationale:y,summaries:D,...O?{rationaleError:O}:{},selectedCandidates:b}}};(function(e){})(p||={});var m=p;Object.defineProperty(exports,`AICompareCandidates`,{enumerable:!0,get:function(){return p}}),exports.default=m;
//# sourceMappingURL=index.cjs.map