Object.defineProperty(exports,`__esModule`,{value:!0});var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`@huggingface/transformers`),l=require(`@langchain/classic/vectorstores/memory`),u=require(`@langchain/core/embeddings`),d=require(`lodash`);d=s(d);let f=require(`jsan`);f=s(f);var p=class extends u.Embeddings{env=c.env;DEBUG=!0;generator=null;generatorModelName=`Xenova/LaMini-GPT-124M`;generatorPromise=null;generatorProgressInfo={};generatorProgressCallback=null;summariser=null;summariserModelName=`Xenova/distilbart-cnn-12-6`;summariserPromise=null;summariserProgressInfo={};summariserProgressCallback=null;embedder=null;embedderModelName=`Xenova/all-MiniLM-L12-v2`;embedderPromise=null;embedderProgressInfo={};embedderProgressCallback=null;tokeniser=null;tokeniserModelName=this.generatorModelName;tokeniserPromise=null;tokeniserProgressInfo={};tokeniserProgressCallback=null;generateSearchAreasMaxNewTokens=64;generateSearchAreasTemperature=.35;generateSearchAreasRepetitionPenalty=1.5;rankingMaxNewTokens=64;rankingTemperature=.35;rankingRepetitionPenalty=1.5;targetSummarisedStringTokenCount=420;static{c.env.localModelPath=``,c.env.allowRemoteModels=!0,c.env.allowLocalModels=!1}constructor(){super({})}async loadGenerator({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.generatorModelName=t),!this.generatorModelName)throw Error(`Invalid generator model name`);return e&&(this.generatorProgressCallback=e),this.generatorPromise=(0,c.pipeline)(`text-generation`,this.generatorModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.generatorProgressInfo,e),this.generatorProgressCallback?.(e))}),this.generator=await this.generatorPromise,this.generator}async checkGeneratorLoaded(){if(this.generatorPromise||this.loadGenerator(),this.generator||await this.generatorPromise,!this.generator)throw Error(`Unable to load generator`)}async loadSummariser({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.summariserModelName=t),!this.summariserModelName)throw Error(`Invalid summariser model name`);return e&&(this.summariserProgressCallback=e),this.summariserPromise=(0,c.pipeline)(`summarization`,this.summariserModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.summariserProgressInfo,e),this.summariserProgressCallback?.(e))}),this.summariser=await this.summariserPromise,this.summariser}async checkSummariserLoaded(){if(this.summariserPromise||this.loadSummariser(),this.summariser||await this.summariserPromise,!this.summariser)throw Error(`Unable to load summariser`)}async loadEmbedder({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.embedderModelName=t),!this.embedderModelName)throw Error(`Invalid embedder model name`);return e&&(this.embedderProgressCallback=e),this.embedderPromise=(0,c.pipeline)(`feature-extraction`,this.embedderModelName,{device:`webgpu`,progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.embedderProgressInfo,e),this.embedderProgressCallback?.(e))}),this.embedder=await this.embedderPromise,this.embedder}async checkEmbedderLoaded(){if(this.embedderPromise||this.loadEmbedder(),this.embedder||await this.embedderPromise,!this.embedder)throw Error(`Unable to load embedder`)}async loadTokeniser({progressCallback:e,modelName:t=``}={}){if(typeof t==`string`&&t&&(this.tokeniserModelName=t),!this.tokeniserModelName)throw Error(`Invalid tokeniser model name`);return e&&(this.tokeniserProgressCallback=e),this.tokeniserPromise=c.AutoTokenizer.from_pretrained(this.tokeniserModelName,{progress_callback:e=>(this.DEBUG&&console.log(f.default.stringify(e)),Object.assign(this.tokeniserProgressInfo,e),this.tokeniserProgressCallback?.(e))}),this.tokeniser=await this.tokeniserPromise,this.tokeniser}async checkTokeniserLoaded(){if(this.tokeniserPromise||this.loadTokeniser(),this.tokeniser||await this.tokeniserPromise,!this.tokeniser)throw Error(`Unable to load tokeniser`)}async embedQuery(e){return await this.checkEmbedderLoaded(),Array.from((await this.embedder?.(e,{pooling:`mean`,normalize:!0}))?.data)}async embedDocuments(e){return Promise.all(e.map(e=>this.embedQuery(e)))}generatePromptTemplate(e){return`Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
`+e+`

### Response:`}defaultGenerateSearchAreasInstruction(e){return`List the relevant subject areas for the following issues. Limit your response to 100 words.
Issues: "`+e+`"`}defaultConvertCandidateToDocument({candidate:e,index:t}={}){let n=`Start of Candidate #`+t;for(let t in e)n+=`
`+d.default.startCase(t)+`: `+(typeof e[t]==`object`?f.default.stringify(e[t]):String(e[t]));return n+=`
End of Candidate #`+t,n}defaultGenerateRankingInstruction({problemDescription:e,summaries:t,candidatesForFinalSelection:n,candidateIdentifierField:r}={}){return`Strictly follow these rules:
1. Rank ONLY the top `+n+` candidates with one 15-word sentence explaining why
2. Rank the candidates based on "`+e.replace(/(\r|\n)/g,` `)+`"
3. If unclear, say "Insufficient information to determine"

Candidates:

`+t.join(`

`)+`

Format exactly:
#1. "[Full `+d.default.startCase(r)+`]": [15-word explanation]
#2. ...`}regexIndexOf(e,t,n){let r=e.slice(n).search(t);return r<0?r:r+n}defaultExtractIdentifierFromCandidateDocument({candidateDocument:e,candidateIdentifierField:t}={}){let n=d.default.startCase(t),r=e.indexOf(n);if(r<0&&(r=e.toLowerCase().indexOf(n.toLowerCase())),r>=0&&(r+=n.length),r<0&&(r=e.toLowerCase().indexOf(t.toLowerCase())),r>=0)r+=t.length;else return``;if(r=e.indexOf(`:`,r),r<0&&(r=this.regexIndexOf(e,/\s+/,r)),r<0)return``;let i=e.indexOf(`
`,r);return i<0&&(i=e.length),e.substring(r,i).trim()}defaultExtractIdentifiersFromRationale(e){let t=/^\s*#\s*\d+\s*\.?\s*"([^"]+)"/gm,n=[];for(let r;Array.isArray(r=t.exec(e));)r[1]&&n.push(r[1]);return n}async compareCandidates({candidates:e,problemDescription:t=``,generateSearchAreasInstruction:n=this.defaultGenerateSearchAreasInstruction.bind(this),convertCandidateToDocument:r=this.defaultConvertCandidateToDocument.bind(this),candidatesForInitialSelection:i=2,candidatesForFinalSelection:a=1,generateRankingInstruction:o=this.defaultGenerateRankingInstruction.bind(this),extractIdentifiersFromRationale:s=this.defaultExtractIdentifiersFromRationale.bind(this),extractIdentifierFromCandidateDocument:c=this.defaultExtractIdentifierFromCandidateDocument.bind(this),candidateIdentifierField:u=void 0,getSummarisableSubstringIndices:f}={}){if(!Array.isArray(e)||e.length<=0)throw Error(`No candidates provided`);if(i=d.default.toSafeInteger(i),i<=0||(a=d.default.toSafeInteger(a),a<=0))throw Error(`Candidates for initial selection must be a positive integer bigger than 0`);if(i<a)throw Error(`Candidates for initial selection must be equal or more than candidates for final selection`);if(i>e.length)throw Error(`There are `+i+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(a>e.length)throw Error(`There are `+a+`candidates for initial selection which is more than the total number of candidates of `+e.length);if(!u&&(u=Object.keys(e[0])[0],!u))throw Error(`No candidate identifier field`);let p=``,m=[];if(await this.checkEmbedderLoaded(),!this.embedder)return;let h=e.map((e,t)=>r({candidate:e,index:t})),g=await l.MemoryVectorStore.fromTexts(d.default.cloneDeep(h),h.map((e,t)=>t),this),_=this.generatePromptTemplate(n(t));if(this.DEBUG&&console.log(`Formatted search areas prompt: `+_),await this.checkTokeniserLoaded(),!this.tokeniser)return;if(this.tokeniser.encode(_).length>this.tokeniser.model_max_length)throw Error(`Search areas instruction prompt is too long for the tokeniser model`);if(await this.checkGeneratorLoaded(),!this.generator)return;let v=this.tokeniser.pad_token_id??this.tokeniser.sep_token_id??0,y=this.tokeniser.sep_token_id??2,b=await this.generator(_,{max_new_tokens:this.generateSearchAreasMaxNewTokens,temperature:this.generateSearchAreasTemperature,repetition_penalty:this.generateSearchAreasRepetitionPenalty,pad_token_id:v,eos_token_id:y}),x=Array.isArray(b?.[0])?b?.[0]?.[0]:b?.[0];if(!x.generated_text)throw Error(`No generated text for search areas`);this.DEBUG&&console.log(`Generated search areas response: `+x.generated_text);let S=x.generated_text.toString().indexOf(`### Response:`);S>=0?S+=13:S=0;let C=x.generated_text.toString().substring(S).trim();C.includes(`.`)&&(C=C.split(`.`)[0].trim()),this.DEBUG&&console.log(`Vector search query: `+C);let w=await g.similaritySearch(C,i),T=[];if(w.some(e=>e.pageContent.trim().split(/\s+/).length>this.targetSummarisedStringTokenCount)){if(await this.checkSummariserLoaded(),!this.summariser)return;T=(await Promise.allSettled(w.map(async e=>{if(!e.pageContent||typeof e.pageContent!=`string`)return``;if(e.pageContent.trim().split(/\s+/).length<=this.targetSummarisedStringTokenCount)return e.pageContent;let t={start:0,end:e.pageContent.length};f&&Object.assign(t,f(e.pageContent)),t.start=d.default.clamp(d.default.toSafeInteger(t.start),0,e.pageContent.length),t.end=d.default.clamp(d.default.toSafeInteger(t.end),0,e.pageContent.length);let n=e.pageContent.substring(t.start,t.end),r=e.pageContent.substring(0,t.start),i=e.pageContent.substring(t.end),a=r.split(/s+/).length+i.split(/s+/).length,o=Math.max(1,420-a),s=await this.summariser?.(n,{max_length:o}),c=r+((Array.isArray(s?.[0])?s?.[0]?.[0]:s?.[0])?.summary_text??``).split(/s+/).slice(o).join(` `)+i;return this.DEBUG&&console.log(`Summarised candidate: `+c),c}))).filter(e=>e.status===`fulfilled`&&e.value).map(e=>e.value)}else T=w.map(e=>e.pageContent);let E=this.generatePromptTemplate(o({problemDescription:t,summaries:T,candidatesForFinalSelection:a,candidateIdentifierField:String(u)}));if(this.DEBUG&&console.log(`Formatted ranking prompt: `+E),this.tokeniser.encode(E).length>this.tokeniser.model_max_length)throw Error(`Ranking instruction prompt is too long for the tokeniser model`);let D=await this.generator(E,{max_new_tokens:this.rankingMaxNewTokens,temperature:this.rankingTemperature,repetition_penalty:this.rankingRepetitionPenalty,pad_token_id:v,eos_token_id:y});p=(Array.isArray(D?.[0])?D?.[0]?.[0]:D[0]).generated_text.toString().trim().replace(/(\*\*)|(<\/?s>)|(\[.*?\])\s*/g,``),this.DEBUG&&console.log(`Generated rationale: `+p);let O=p.indexOf(`### Response:`);if(O>=0?O+=13:O=0,p=p.substring(O),p){let t=s(p);t.length>a&&(t=t.slice(0,a)),m=d.default.compact(t.map(t=>{let n=e.find(e=>String(e[u]).toLowerCase()===t.toLowerCase());return n||(n=e.find(e=>String(e[u]).toLowerCase().includes(t.toLowerCase())),n)||(n=e.find(e=>t.toLowerCase().includes(String(e[u]).toLowerCase())),n)?n:null}))}return(!Array.isArray(m)||m.length<=0)&&(m=d.default.uniq(d.default.compact(w.map(t=>{let n=c({candidateDocument:t.pageContent,candidateIdentifierField:String(u)}),r=e.find(e=>String(e[u]).toLowerCase()===n.toLowerCase());return r||(r=e.find(e=>String(e[u]).toLowerCase().includes(n.toLowerCase())),r)||(r=e.find(e=>n.toLowerCase().includes(String(e[u]).toLowerCase())),r)?r:null})))),this.DEBUG&&console.log(`Selected candidates`,m),{rationale:p,selectedCandidates:m}}};(function(e){})(p||={});var m=p;Object.defineProperty(exports,`AICompareCandidates`,{enumerable:!0,get:function(){return p}}),exports.default=m;
//# sourceMappingURL=index.cjs.map